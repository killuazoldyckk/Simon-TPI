services:
  backend:
    build: ../backend
    container_name: simon-backend
    command: gunicorn -k uvicorn.workers.UvicornWorker -w 4 -b 0.0.0.0:8000 main:app
    ports:
      - "8000:8000"
    volumes:
      - ../backend:/app
    environment:
      - DATABASE_URL=mysql+pymysql://sikerang_simontpi:SX2HMdAB5SahnuyXUyg7@host.docker.internal:3306/sikerang_simontpi
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=simon-access-key
      - MINIO_SECRET_KEY=simon-secret-key

  frontend:
    build: ../frontend
    container_name: simon-frontend
    command: npm run dev -- --host 0.0.0.0
    ports:
      - "5173:5173"
    volumes:
      - ../frontend:/app
      - /app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5173"]
      interval: 10s
      timeout: 5s
      retries: 5

  nginx:
    image: nginx:latest
    container_name: simon-nginx
    ports:
      - "80:80"
      - "9002:9002"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_started
      minio:
        condition: service_started

  minio:
    image: minio/minio:latest
    container_name: simon-minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=simon-access-key
      - MINIO_ROOT_PASSWORD=simon-secret-key
      - MINIO_BROWSER_REDIRECT_URL=http://localhost:9002
    volumes:
      - ./minio_data:/data